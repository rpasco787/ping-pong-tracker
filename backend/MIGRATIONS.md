# Database Migrations with Alembic

This project uses Alembic for managing database migrations with SQLModel.

## Setup Complete! ✅

Alembic is now configured and ready to use with your SQLModel setup.

## How to Use Alembic

### 1. Create Your Initial Migration

Generate the first migration based on your current models:

```bash
cd backend
alembic revision --autogenerate -m "Initial migration"
```

This will:
- Scan your SQLModel models (Player, Match, GameScore)
- Create a migration file in `alembic/versions/`
- Detect all tables and columns that need to be created

### 2. Review the Migration

Check the generated file in `alembic/versions/`. It should contain:
- `upgrade()` function: Creates tables
- `downgrade()` function: Drops tables

### 3. Apply the Migration

Run the migration to create your tables:

```bash
alembic upgrade head
```

This creates all tables in your database.

### 4. Check Migration Status

See which migrations have been applied:

```bash
alembic current
alembic history
```

## Common Workflows

### Adding a New Field to a Model

1. Edit your model in `app/db.py`:
```python
class Player(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    name: str = Field(index=True)
    email: Optional[str] = Field(default=None, unique=True)
    wins: int = Field(default=0)
    losses: int = Field(default=0)
    points: int = Field(default=0)
    ranking: Optional[int] = Field(default=None)  # NEW FIELD
```

2. Generate migration:
```bash
alembic revision --autogenerate -m "Add ranking to Player"
```

3. Review the migration file

4. Apply it:
```bash
alembic upgrade head
```

### Creating a New Table

1. Define your model in `app/db.py`

2. Import it in `alembic/env.py` (so Alembic can detect it)

3. Generate migration:
```bash
alembic revision --autogenerate -m "Add Tournament table"
```

4. Apply it:
```bash
alembic upgrade head
```

### Rolling Back a Migration

Go back one migration:
```bash
alembic downgrade -1
```

Go back to a specific revision:
```bash
alembic downgrade <revision_id>
```

Go back to the beginning (drop all tables):
```bash
alembic downgrade base
```

### Creating a Manual Migration

For complex changes that autogenerate might miss:

```bash
alembic revision -m "Add custom index"
```

Then edit the generated file manually.

## Useful Commands

| Command | Description |
|---------|-------------|
| `alembic upgrade head` | Apply all pending migrations |
| `alembic downgrade -1` | Rollback the last migration |
| `alembic current` | Show current revision |
| `alembic history` | Show all revisions |
| `alembic revision --autogenerate -m "message"` | Generate new migration |
| `alembic stamp head` | Mark database as up-to-date without running migrations |

## Important Notes

### Autogenerate Limitations

Alembic's autogenerate is powerful but has limitations:
- ✅ Detects: New tables, new columns, column type changes
- ❌ May miss: Column renames, constraint name changes, some index changes

Always review generated migrations before applying!

### SQLModel Compatibility

The `alembic/env.py` is configured to:
- Use your `DATABASE_URL` from `app/db.py`
- Import your SQLModel metadata
- Automatically detect all your models

### Production Best Practices

1. **Never** run migrations directly on production without testing
2. **Always** backup your database before running migrations
3. **Review** autogenerated migrations carefully
4. **Test** migrations on a staging environment first
5. Keep migrations in version control

### Environment-Specific Migrations

For different databases (SQLite dev, PostgreSQL prod):

```bash
# Development (SQLite)
alembic upgrade head

# Production (PostgreSQL)
export DATABASE_URL="postgresql://user:pass@host/db"
alembic upgrade head
```

## Troubleshooting

### "Target database is not up to date"
```bash
alembic stamp head
```

### Migration conflicts
```bash
alembic merge heads
```

### Start fresh (CAREFUL - destroys data!)
```bash
# Drop all tables
alembic downgrade base

# Remove all migration files
rm alembic/versions/*.py

# Recreate initial migration
alembic revision --autogenerate -m "Initial migration"

# Apply it
alembic upgrade head
```

## Example: Complete Migration Workflow

```bash
# 1. Install dependencies
pip install -r requirements.txt

# 2. Create initial migration
alembic revision --autogenerate -m "Initial migration with Player, Match, GameScore"

# 3. Apply migration
alembic upgrade head

# 4. Start your app
uvicorn app.main:app --reload

# Later: Add a new field
# Edit app/db.py

# 5. Generate migration for changes
alembic revision --autogenerate -m "Add profile_image to Player"

# 6. Apply the new migration
alembic upgrade head
```

## Integration with CI/CD

Add to your deployment script:

```bash
# Run migrations before starting the app
alembic upgrade head

# Then start the app
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

---

**Need help?** Check the [Alembic documentation](https://alembic.sqlalchemy.org/)

